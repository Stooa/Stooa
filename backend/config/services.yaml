# This file is part of the Stooa codebase.
#
# (c) 2020 - present Runroom SL
#
# For the full copyright and license information, please view the LICENSE
# file that was distributed with this source code.

parameters:
    locale: en
    locales: [ en, es, ca, fr, id ]
    container.dumper.inline_factories: true
    container.dumper.inline_class_loader: true
    jaas_activated: '%env(JAAS_ACTIVE)%'

services:
    _defaults:
        autowire: true
        autoconfigure: true

    # Vendors
    Gedmo\Timestampable\TimestampableListener:
        tags: [doctrine.event_subscriber]
        calls:
            - [setAnnotationReader, ['@annotation_reader']]

    # App
    App\:
        resource: ../src/
        exclude:
            - ../src/DependencyInjection/
            - ../src/Entity/
            - ../src/Kernel.php

    App\Controller\:
        resource: ../src/Controller/
        tags: [controller.service_arguments]

    App\EventSubscriber\LocaleSubscriber:
        bind:
            $locales: '%locales%'

    App\OpenApi\OpenApiFactory:
        decorates: api_platform.openapi.factory
        arguments:
            - '@App\OpenApi\OpenApiFactory.inner'
        autoconfigure: false

    App\DataPersister\UserDataPersister:
        decorates: api_platform.doctrine.orm.data_persister

    App\DataPersister\FishbowlDataPersister:
        decorates: api_platform.doctrine.orm.data_persister

    App\Service\MailerService:
        bind:
            $from: '%env(MAILER_FROM)%'
            $appUrl: '%env(APP_URL)%'

    App\JWT\TokenGenerator\JaasTokenGenerator:
        bind:
            $appId: '%env(JAAS_APP_ID)%'
            $apiKey: '%env(JAAS_API_KEY)%'

    App\Encryption\HalitePasswordEncryption:
        bind:
            $key: '%env(HALITE_KEY)%'

    App\Stage\FishbowlValidateStage:
        decorates: api_platform.graphql.resolver.stage.validate

    App\DataProvider\FishbowlDataProvider:
        bind:
            $collectionDataProvider: '@api_platform.doctrine.orm.default.collection_data_provider'

    # Admin
    App\Admin\UserAdmin:
        tags:
            - { name: sonata.admin, model_class: App\Entity\User, manager_type: orm, label: Users }
        calls:
            - [setPasswordEncoder, ['@App\Security\PasswordEncoderService']]
            - [setMailerService, ['@App\Service\MailerService']]

    App\Admin\FishbowlAdmin:
        tags:
            - { name: sonata.admin, model_class: App\Entity\Fishbowl, manager_type: orm, label: Fishbowls }
        calls:
            - [setFishbowlService, ['@App\Service\FishbowlService']]

    App\Admin\ResetPasswordRequestAdmin:
        tags:
            - { name: sonata.admin, model_class: App\Entity\ResetPasswordRequest, manager_type: orm, label: Reset Password Requests }

    App\Admin\ParticipantAdmin:
        tags:
            - { name: sonata.admin, model_class: App\Entity\Participant, manager_type: orm, label: Participants }

    App\Admin\GuestAdmin:
        tags:
            - { name: sonata.admin, model_class: App\Entity\Guest, manager_type: orm, label: Guests }
